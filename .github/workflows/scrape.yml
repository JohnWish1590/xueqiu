name: Scrape Xueqiu and Build Pages

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          npm ci || npm i
          npx playwright install --with-deps chromium

      - name: Login check
        env:
          XUEQIU_COOKIE: ${{ secrets.XUEQIU_COOKIE }}
        run: |
          node scripts/login_check.js

      - name: Sync following (if enabled)
        env:
          XUEQIU_COOKIE: ${{ secrets.XUEQIU_COOKIE }}
        run: |
          node scripts/sync_following.js

      - name: Scrape
        env:
          XUEQIU_COOKIE: ${{ secrets.XUEQIU_COOKIE }}
        run: |
          node scripts/scrape.js

      - name: Parse & Build
        run: |
          node scripts/parse.js
          node scripts/build.js

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./web

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
